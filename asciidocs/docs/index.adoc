= Einführung in Prometheus
ifndef::imagesdir[:imagesdir: images]
Autor: Bajtik Berg
Version: 1.0
:toc: left
:toc-title: Inhaltsverzeichnis
:icons: font
:sectnums:
:source-highlighter: rouge

== Einleitung

Prometheus ist ein Open-Source-Tool zur Überwachung von Systemen und Anwendungen. Es sammelt regelmäßig Messwerte
(Metriken), etwa zur CPU-Auslastung, Anzahl von Anfragen oder Speichernutzung.

Diese Daten speichert Prometheus in einer Zeitreihendatenbank. So kann man sehen, wie sich bestimmte Werte im Zeitverlauf verändern. Mit der eigenen Abfragesprache PromQL lassen sich die Daten gezielt auswerten.

=== Welches Problem löst Prometheus?

Moderne Software-Systeme bestehen oft aus vielen kleinen Diensten (Microservices), die dynamisch in Containern laufen. In dieser komplexen Umgebung wird es schwierig, den Überblick über den Zustand der Systeme zu behalten:

- Läuft alles wie erwartet?
- Warum ist die Anwendung plötzlich langsam?
- Gibt es Fehlermuster, bevor ein Absturz passiert?

Prometheus löst genau dieses Problem: Es sammelt regelmäßig präzise Messdaten über den Zustand und das Verhalten einer Anwendung. So kann man Fehler früh erkennen, Engpässe analysieren und Systeme effizienter betreiben.

== Warum Prometheus?

Prometheus ist besonders beliebt, weil es einige wichtige Vorteile mitbringt:

- **Einfach zu integrieren:** Man muss nur einen Endpoint bereitstellen, an dem Prometheus regelmäßig Messwerte abfragen kann.
- **Eigene Abfragesprache (PromQL):** Ermöglicht sehr gezielte Auswertungen.
- **Gute Visualisierung mit Grafana:** Daten können übersichtlich in Dashboards dargestellt werden.

== Architektur von Prometheus

image::architecture.png[title="Prometheus Architektur"]

- **Prometheus-Server:** Fragt regelmäßig Metriken ab und speichert sie.
- **Exporters / Jobs:** Stellen Metriken unter `/metrics` bereit.
- **Pushgateway:** Unterstützt kurzlebige Jobs, die Metriken einmalig senden.
- **Service Discovery:** Erkennt automatisch neue Dienste (z. B. in Kubernetes).
- **Alertmanager:** Versendet Warnungen auf Basis definierter Regeln.
- **Grafana:** Visualisiert Metriken in Dashboards.
- **Web UI:** Interface für direkte PromQL-Abfragen.

== Prometheus in Quarkus

Quarkus bietet eine integrierte Unterstützung für Micrometer und Prometheus. Die Metriken werden unter `/q/metrics` bereitgestellt. Voraussetzung dafür ist die Erweiterung `quarkus-micrometer-registry-prometheus`.

=== Konfiguration in Quarkus

[source,properties]
----
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics
----

Beispiel für `prometheus.yml`:

[source,yaml]
----
scrape_configs:
  - job_name: 'quarkus-app'
    static_configs:
      - targets: [ 'quarkus:8080' ]
----

=== Eigene Metriken in Resource-Klassen

Mit dem `MeterRegistry` lassen sich benutzerdefinierte Metriken erzeugen:

*Zähler (Counter)*

[source,java]
----
registry.counter("person_counter").increment();
----

*Timer*

[source,java]
----
Timer.Sample sample = Timer.start(registry);
// Operation
sample.stop(registry.timer("person_timer"));
----

*Gauge (z. B. Listengröße)*

[source,java]
----
registry.gaugeCollectionSize("person_list_size", Tags.empty(), myList);
----

Diese Metriken erscheinen dann automatisch im `/q/metrics`-Output.

=== PromQL-Beispiele für Quarkus

[source,promql]
----
person_counter
person_timer_count
person_list_size
http_server_requests_seconds_count{job="quarkus-app"}
----

Diese Abfragen funktionieren direkt im Prometheus-Interface oder in Grafana.

== PromQL – Die Abfragesprache von Prometheus

PromQL ist eine leistungsstarke Sprache zur Analyse von Metriken.

=== Beispiele

* **Alle Metriken anzeigen**
[source,promql]
----
{__name__=~".*"}
----

* **Durchschnittliche CPU-Auslastung (Beispiel für Systemmetriken)**
[source,promql]
----
avg(rate(cpu_usage_seconds_total[5m]))
----

* **Summe eines eigenen Counters**
[source,promql]
----
sum(person_counter)
----

== Fazit

Prometheus ist ein leistungsstarkes Tool zur Überwachung moderner Anwendungen. Besonders in Verbindung mit Quarkus ist es einfach zu integrieren und bietet umfangreiche Möglichkeiten zur Analyse und Visualisierung von Metriken.

== Quellen

* https://prometheus.io/docs/introduction/overview/[Prometheus Overview]
* https://prometheus.io/docs/introduction/first_steps/[Prometheus First Steps]
* https://grafana.com/docs/grafana/latest/datasources/prometheus/[Grafana Prometheus]